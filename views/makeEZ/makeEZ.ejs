<!doctype html>
<html lang="zh">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/bower_components/bootstrap/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/bower_components/font-awesome-4.3.0/css/font-awesome.css"/>
    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="/bower_components/less/dist/less.min.js"></script>
    <script>
        (function () {
            function _sparrow() {
                this.models = {};
                this.sparrowWatchers = [];
                this.registerModel = function (name, func) {
                    this.models[name] = new func();
                    this.models[name].cst = func;
                    return this;
                };
            }

            var sparrow = new _sparrow();
            /*model处理*/
            function initialModels(modelElement, resolved) {
                var subModel = modelElement.attr('model').split('-')[0],
                        superModel = modelElement.attr('model').split('-').length > 1 ? modelElement.attr('model').split('-')[1] : undefined;
                if (superModel) {
                    if (resolved) return sparrow.models[subModel];
                    var cst = sparrow.models[subModel].cst;
                    sparrow.models[subModel].cst.prototype = sparrow.models[superModel];
                    sparrow.models[subModel] = new sparrow.models[subModel].cst();
                    sparrow.models[subModel].cst = cst;
//                    console.log(sparrow.models[subModel]);
                }
                return sparrow.models[subModel]
            }

            /*启动应用*/
            _sparrow.prototype.bootstrap = function () {
                $(function () {
                    sparrow.modelCheck();
                    sparrow.initialSparrowWatchers();
//                    var dirtyCheckInterval=setInterval(sparrow.dirtyCheck,500);
                    /**/

                })
            };
            /*数据初始化绑定*/
            _sparrow.prototype.modelCheck = function (resolved) {
                $('[model]').each(function () {
                    var model = initialModels($(this), resolved);
                    $(this).find('[data-sparrow]').each(function () {
                        var dataName = $(this).data('sparrow');
                        if (model[dataName]) {
                            $(this).prop('nodeName') == 'INPUT' || $(this).prop('nodeName') == 'TEXTAREA' ? $(this).val(model[dataName]) : $(this).html(model[dataName]);
                            $(this).data('sparrowWatched', {
                                model: model, watchName: dataName, watchElem: $(this), oldValue: model[dataName]
                            });
                        }
                    })
                });
            };
            /*绑定队列*/
            _sparrow.prototype.initialSparrowWatchers = function () {
                sparrow.sparrowWatchers = [];
                $('[data-sparrow]').each(function () {
                    sparrow.sparrowWatchers.push($(this).data('sparrowWatched'))
                });
//                console.log(sparrow)
            };

            /*脏值检查*/
            _sparrow.prototype.dirtyCheck = function () {
                var existDirtyData = false;
                for (var i = 0; i < sparrow.sparrowWatchers.length; i++) {
                    var sparrowWatcher = sparrow.sparrowWatchers[i];
                    if (sparrowWatcher.watchElem.prop('nodeName') == 'INPUT' ||
                            sparrowWatcher.watchElem.prop('nodeName') == 'TEXTAREA') {
                        if (sparrowWatcher.model[sparrowWatcher.watchName] != sparrowWatcher.watchElem.val()) {
                            existDirtyData = true;
                            if (sparrowWatcher.model[sparrowWatcher.watchName] == sparrowWatcher.oldValue) {
                                sparrowWatcher.model[sparrowWatcher.watchName] = sparrowWatcher.watchElem.val();
                                sparrowWatcher.oldValue = sparrowWatcher.watchElem.val();
                            } else {
                                sparrowWatcher.watchElem.val(sparrowWatcher.model[sparrowWatcher.watchName]);
                                sparrowWatcher.oldValue = sparrowWatcher.model[sparrowWatcher.watchName]
                            }
                        }
                    }
                    else if (sparrowWatcher.model[sparrowWatcher.watchName] != sparrowWatcher.watchElem.html()) {
                        existDirtyData = true;
                        if (sparrowWatcher.model[sparrowWatcher.watchName] == sparrowWatcher.oldValue) {
                            sparrowWatcher.model[sparrowWatcher.watchName] = sparrowWatcher.watchElem.html();
                            sparrowWatcher.oldValue = sparrowWatcher.watchElem.html()
                        } else {
                            sparrowWatcher.watchElem.html(sparrowWatcher.model[sparrowWatcher.watchName]);
                            sparrowWatcher.oldValue = sparrowWatcher.model[sparrowWatcher.watchName]
                        }
                    }
                }
                existDirtyData && arguments.callee();
            };
            _sparrow.prototype.safeChange = function (func) {

            };
            /*前端路由的实现*/

            window.sparrow = sparrow;
        })()
    </script>
    <script>
        (function () {
            sparrow.registerView = function (name, path, parentView) {
                sparrow.views = sparrow.views == undefined ? {} : sparrow.views
                sparrow.views[name] = {};
                sparrow.views[name].path = path;
                parentView && (sparrow.views[name].parentView = parentView)
                return this;
            }
            /*视图的跳转，支持二级视图，但是有异步操作也许有bug*/
            sparrow.go = function (viewName, parentBeResolved) {
                var parentView = sparrow.views[viewName].parentView;
                if (parentView) {
                    $.get(sparrow.views[parentView].path).success(function (data) {
                        $('[sparrow-view]').empty().append(data);
                        $.get(sparrow.views[viewName].path, function (data) {
                            $('[sparrow-view]').find('[sparrow-view]').empty().append(data);
                            sparrow.bootstrap();
                        })
                    })
                } else {
                    $.get(sparrow.views[viewName].path, function (data) {
                        $('[sparrow-view]').empty().append(data);
                        sparrow.bootstrap();
                    })
                }
            }
        })()
    </script>
    <script>
        /*demo*/
        sparrow.registerModel('A', function () {
            this.name = 'A';
            this.age = 24;
            this.input = 'lll'
        }).registerModel('a', function () {
            this.name = 'a';
            this.addr = 'suzhou';
            this.age = 12;
        }).registerModel('aa', function () {
            this.name = 'aa';
            this.addr = 'nantong'
        }).registerView('home', '/makeEZ/test.html').registerView('inner', '/makeEZ/inner.html', 'home')
        console.log(sparrow);
        sparrow.bootstrap();
        //        sparrow.go('home');
    </script>
</head>
<body>
<div model="A">
    <span data-sparrow="name"></span>

    <div model="a-A">
        <div model="aa-a">
            <span data-sparrow="age"></span>
        </div>
        <span data-sparrow="addr"></span><br/>
    </div>

    <span data-sparrow="age"></span>
    <span data-sparrow="input"></span>
    <input data-sparrow="input" type="text"/>
    <br/>
    <textarea data-sparrow="input" name="" id="" cols="30" rows="10">
    </textarea>

    <div sparrow-view="main">
        <div sparrow-view="inner"></div>
    </div>
</div>
<button>dirtyCheck</button>
<button id="test">go to test.html</button>
<script>
    $('button').click(function () {
        sparrow.dirtyCheck();
    });
    $('input').change(function () {
        sparrow.dirtyCheck();
    });
    $('textarea').change(function () {
        sparrow.dirtyCheck();
    })
    $('#test').click(function () {
        sparrow.go('inner')
    });
</script>
</body>
</html>